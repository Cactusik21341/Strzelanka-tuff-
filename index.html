<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gra Strzelanka</title>
<style>
body {
  margin:0;
  background:#111;
  font-family:Arial;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
}
canvas {
  background:#222;
  border:2px solid white;
  margin-top:20px;
}
button,input {
  margin:5px;
  padding:10px;
}
#controls{
  margin-top:10px;
}
.hint{
  position:absolute;
  top:10px;
  right:10px;
  background: rgba(0,0,0,0.6);
  padding:6px 10px;
  border-radius:6px;
}
#leaderboard{
  position:absolute;
  top:10px;
  left:10px;
  background:#222;
  padding:10px;
  border:2px solid white;
  width:200px;
  text-align:center;
}
</style>
</head>
<body>

<div id="controls">
  <input id="nicknameInput" placeholder="Wpisz nick">
  <button id="startBtn">Start Gry</button>
  <button id="endBtn" style="display:none;">Zakończ grę</button>
  <button id="restartBtn" style="display:none;">Zagraj ponownie</button>
  <button id="resetBoardBtn" style="display:none;">Resetuj leaderboard</button>
</div>

<canvas id="game" width="800" height="600"></canvas>
<div class="hint" id="hint">Broń: Pistolet | Kup shotgun: E (50 pkt)</div>
<div id="leaderboard">
  <h3>Leaderboard</h3>
  <ol id="scoresList"></ol>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const hint=document.getElementById("hint");
const scoresList=document.getElementById("scoresList");

const nicknameInput=document.getElementById("nicknameInput");
const startBtn=document.getElementById("startBtn");
const endBtn=document.getElementById("endBtn");
const restartBtn=document.getElementById("restartBtn");
const resetBoardBtn=document.getElementById("resetBoardBtn");

let player,bullets,enemies,score,weapon,keys,playing,nickname;
let leaderboard={};
let enemyInterval,animationFrameId;

function initGame(){
  player={x:400,y:500,w:40,h:40,speed:5};
  bullets=[];
  enemies=[];
  score=0;
  weapon="normal";
  keys={};
  updateHint();
}

function loadBoard(){
  const data=localStorage.getItem("leaderboard");
  if(data) leaderboard=JSON.parse(data);
  renderBoard();
}
function saveBoard(){
  leaderboard[nickname]=score;
  localStorage.setItem("leaderboard",JSON.stringify(leaderboard));
  renderBoard();
}
function renderBoard(){
  scoresList.innerHTML="";
  for(let n in leaderboard) scoresList.innerHTML+=`<li>${n}: ${leaderboard[n]}</li>`;
}

// spawn wrogów
function spawnEnemy(){
  if(!playing) return;
  const x=Math.random()*(canvas.width-40);
  const y=-40;
  enemies.push({x,y,w:40,h:40,speed:1.5});
}

// rysowanie
function drawPlayer(){ ctx.fillStyle="cyan"; ctx.fillRect(player.x,player.y,player.w,player.h); }
function drawBullets(){ ctx.fillStyle="yellow"; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h)); }
function drawEnemies(){ ctx.fillStyle="red"; enemies.forEach(e=>ctx.fillRect(e.x,e.y,e.w,e.h)); }
function drawScore(){ ctx.fillStyle="white"; ctx.font="20px Arial"; ctx.fillText("Punkty: "+score,10,25); }
function updateHint(){ 
  const own=weapon=="shotgun"?"Shotgun":"Pistolet"; 
  const buy=weapon=="shotgun"?"":" | Kup shotgun: E (50 pkt)";
  hint.textContent=`Broń: ${own}${buy}`;
}

// strzelanie
function shoot(){
  if(!playing) return;
  if(weapon=="normal") bullets.push({x:player.x+18,y:player.y,w:5,h:10,speed:7,vx:0});
  else{
    bullets.push({x:player.x+18,y:player.y,w:6,h:12,speed:7,vx:0});
    bullets.push({x:player.x+18,y:player.y,w:6,h:12,speed:7,vx:-2});
    bullets.push({x:player.x+18,y:player.y,w:6,h:12,speed:7,vx:2});
  }
}

// ruch gracza
function movePlayer(){
  if(keys['w']) player.y-=player.speed;
  if(keys['s']) player.y+=player.speed;
  if(keys['a']) player.x-=player.speed;
  if(keys['d']) player.x+=player.speed;
  player.x=Math.max(0,Math.min(canvas.width-player.w, player.x));
  player.y=Math.max(0,Math.min(canvas.height-player.h, player.y));
}

// ruch pocisków
function moveBullets(){
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.y-=b.speed;
    if(b.vx) b.x+=b.vx;
    if(b.y<-20 || b.x<-20 || b.x>canvas.width+20) bullets.splice(i,1);
  }
}

// ruch wrogów
function moveEnemies(){
  enemies.forEach(e=>{
    const dx=player.x-e.x, dy=player.y-e.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist!=0){ e.x+=(dx/dist)*e.speed; e.y+=(dy/dist)*e.speed; }
  });
}

// kolizje
function checkCollisions(){
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(!b||!e) continue;
      if(b.x<e.x+e.w && b.x+b.w>e.x && b.y<e.y+e.h && b.y+b.h>e.y){
        enemies.splice(i,1);
        bullets.splice(j,1);
        score++;
        updateHint();
        break;
      }
    }
  }
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    if(player.x<e.x+e.w && player.x+player.w>e.x && player.y<e.y+e.h && player.y+player.h>e.y){
      enemies.splice(i,1);
      score--;
      updateHint();
    }
  }
}

// pętla gry
function gameLoop(){
  if(!playing) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  movePlayer();
  moveBullets();
  drawPlayer();
  drawBullets();
  moveEnemies();
  drawEnemies();
  checkCollisions();
  drawScore();
  animationFrameId=requestAnimationFrame(gameLoop);
}

// zatrzymanie gry
function stopGame(){
  playing=false;
  clearInterval(enemyInterval);
  if(animationFrameId) cancelAnimationFrame(animationFrameId);
}

// klawiatura
document.addEventListener("keydown",e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key===" ") shoot();
  if(e.key.toLowerCase()==="e" && weapon==="normal" && score>=50){ score-=50; weapon="shotgun"; updateHint(); }
});
document.addEventListener("keyup",e=>{ keys[e.key.toLowerCase()]=false; });

// START
startBtn.onclick=()=>{
  nickname=nicknameInput.value||"Gracz";
  startBtn.style.display="none";
  nicknameInput.style.display="none";
  endBtn.style.display="inline-block";
  restartBtn.style.display="inline-block";
  resetBoardBtn.style.display=(nickname==="test6521")?"inline-block":"none";
  initGame();
  loadBoard();
  playing=true;
  enemyInterval=setInterval(spawnEnemy,800);
  gameLoop();
}

// KONIEC
endBtn.onclick=()=>{
  stopGame();
  saveBoard();
  alert(`Gra zakończona! Twój wynik: ${score}`);
}

// RESTART
restartBtn.onclick=()=>{
  stopGame();
  initGame();
  playing=true;
  enemyInterval=setInterval(spawnEnemy,800);
  gameLoop();
}

// RESET LEADERBOARD
resetBoardBtn.onclick=()=>{
  if(nickname==="test6521"){
    leaderboard={};
    localStorage.removeItem("leaderboard");
    renderBoard();
    alert("Leaderboard został zresetowany!");
  }
}
</script>

</body>
</html>

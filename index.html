<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Strzelanka — Pistolet & UZI</title>
<style>
  :root{--bg:#0b0b0b;--panel:#1f1f1f;--accent:#fff}
  body{margin:0;background:var(--bg);color:var(--accent);font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  #container{display:flex;flex-direction:row;height:100vh;align-items:center;justify-content:center}
  #gameArea{position:relative;display:flex;align-items:center;justify-content:center}
  canvas{background:#111;border:3px solid #fff;display:block}
  #sidePanel{
    position:relative;
    width:320px;
    margin-left:20px;
    background:var(--panel);
    padding:12px;
    border-radius:8px;
    box-shadow:0 6px 18px rgba(0,0,0,0.6);
    height:88vh;
    overflow:auto;
  }
  h2{margin:6px 0 8px 0;text-align:center}
  .control-row{margin:8px 0;display:flex;flex-direction:column;gap:8px}
  input[type="text"]{padding:8px;font-size:16px;border-radius:6px;border:1px solid #444;background:#0f0f0f;color:var(--accent)}
  button{padding:8px;font-size:15px;border-radius:6px;border:1px solid #444;background:#222;color:var(--accent);cursor:pointer}
  button.small{padding:6px;font-size:13px}
  #hint{background:rgba(255,255,255,0.03);padding:8px;border-radius:6px;border:1px solid #333}
  #leaderboard{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;border:1px solid #333;margin-top:10px}
  ol{padding-left:18px;margin:6px 0}
  #adminBtns{position:sticky;bottom:12px;margin-top:12px;display:flex;flex-direction:column;gap:8px}
  #sidePanel,button,input{z-index:999}
  @media (max-width:980px){
    #container{flex-direction:column}
    #sidePanel{width:95%;margin:12px 0;height:auto}
    canvas{width:95%;height:auto}
  }
</style>
</head>
<body>
<div id="container">
  <div id="gameArea">
    <canvas id="game" width="800" height="600"></canvas>
  </div>

  <div id="sidePanel">
    <h2>STRZELANKA</h2>

    <div class="control-row" id="menuControls">
      <input id="nicknameInput" placeholder="Wpisz nick" maxlength="20" />
      <button id="startBtn">Start gry</button>
    </div>

    <div class="control-row" id="inGameControls" style="display:none">
      <div style="display:flex;gap:8px">
        <button id="endBtn" class="small">Zakończ grę</button>
        <button id="restartBtn" class="small">Zagraj ponownie</button>
      </div>
      <div id="hint" style="margin-top:6px">Broń: Pistolet | Kup shotgun: E (50 pkt) | Kup UZI: Q (150 pkt)</div>
    </div>

    <div id="leaderboard">
      <h3 style="margin-top:0">Leaderboard</h3>
      <ol id="scoresList"></ol>
    </div>

    <div id="adminBtns" style="display:none">
      <button id="add100Btn" class="small">Dodaj +100 pkt (test6521)</button>
      <button id="resetBoardBtn" class="small">Resetuj leaderboard (test6521)</button>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const nicknameInput = document.getElementById('nicknameInput');
const startBtn = document.getElementById('startBtn');
const endBtn = document.getElementById('endBtn');
const restartBtn = document.getElementById('restartBtn');
const hintBox = document.getElementById('hint');
const scoresList = document.getElementById('scoresList');
const menuControls = document.getElementById('menuControls');
const inGameControls = document.getElementById('inGameControls');
const adminBtns = document.getElementById('adminBtns');
const add100Btn = document.getElementById('add100Btn');
const resetBoardBtn = document.getElementById('resetBoardBtn');

let player, bullets, enemies, score, weapon, keys, playing, nickname;
let leaderboard = {};
let enemyInterval = null;
let animationFrameId = null;
let uziInterval = null;

const WEAPONS = { PISTOL:'pistol', SHOTGUN:'shotgun', UZI:'uzi' };
const SHOTGUN_COST = 50;
const UZI_COST = 150;

function loadBoard(){
  const raw = localStorage.getItem('leaderboard');
  try{ leaderboard = raw ? JSON.parse(raw) : {}; } catch(e){ leaderboard = {} }
  renderBoard();
}
function saveBoard(){
  if(!nickname) return;
  leaderboard[nickname] = score;
  localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
  renderBoard();
}
function renderBoard(){
  const entries = Object.entries(leaderboard).sort((a,b)=> b[1]-a[1]);
  scoresList.innerHTML = '';
  for(const [n,s] of entries){
    const li = document.createElement('li');
    li.textContent = `${n}: ${s}`;
    scoresList.appendChild(li);
  }
}

function initGameState(){
  player = { x: Math.floor(canvas.width/2)-20, y: canvas.height-100, w:40, h:40, speed:5 };
  bullets = [];
  enemies = [];
  score = 0;
  weapon = WEAPONS.PISTOL;
  keys = {};
  updateHint();
}

function updateHint(){
  const own = weapon === WEAPONS.SHOTGUN ? 'Shotgun' : (weapon === WEAPONS.UZI ? 'UZI' : 'Pistolet');
  let buy = '';
  if(weapon === WEAPONS.PISTOL) buy = ` | Kup shotgun: E (${SHOTGUN_COST} pkt) | Kup UZI: Q (${UZI_COST} pkt)`;
  else if(weapon === WEAPONS.SHOTGUN) buy = ` | Kup UZI: Q (${UZI_COST} pkt)`;
  hintBox.textContent = `Broń: ${own}${buy}`;
}

function spawnEnemy(){
  if(!playing) return;
  const x = Math.random() * (canvas.width - 40);
  enemies.push({ x, y: -40, w:40, h:40, speed: 1.5 });
}

function shoot(){
  if(!playing) return;
  if(weapon === WEAPONS.PISTOL){
    bullets.push({ x: player.x + 18, y: player.y, w:5, h:10, speed:8, vx:0 });
  } else if(weapon === WEAPONS.SHOTGUN){
    bullets.push({ x: player.x + 18, y: player.y, w:6, h:12, speed:7, vx:0 });
    bullets.push({ x: player.x + 18, y: player.y, w:6, h:12, speed:7, vx:-2 });
    bullets.push({ x: player.x + 18, y: player.y, w:6, h:12, speed:7, vx:2 });
  } else if(weapon === WEAPONS.UZI){
    const spread = (Math.random()*2 -1) * 1.2;
    bullets.push({ x: player.x + 18, y: player.y, w:4, h:8, speed:10, vx:spread });
  }
}

function movePlayer(){
  if(keys['w']) player.y -= player.speed;
  if(keys['s']) player.y += player.speed;
  if(keys['a']) player.x -= player.speed;
  if(keys['d']) player.x += player.speed;
  player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));
  player.y = Math.max(0, Math.min(canvas.height - player.h, player.y));
}
function moveBullets(){
  for(let i=bullets.length-1;i>=0;i--){
    const b = bullets[i];
    b.y -= b.speed;
    if(b.vx) b.x += b.vx;
    if(b.y < -30 || b.x < -60 || b.x > canvas.width + 60) bullets.splice(i,1);
  }
}
function moveEnemies(){
  for(const e of enemies){
    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if(dist !== 0){ e.x += (dx/dist) * e.speed; e.y += (dy/dist) * e.speed; }
  }
}
function checkCollisions(){
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    let died = false;
    for(let j=bullets.length-1;j>=0;j--){
      const b = bullets[j];
      if(!b || !e) continue;
      if(b.x < e.x + e.w && b.x + b.w > e.x && b.y < e.y + e.h && b.y + b.h > e.y){
        enemies.splice(i,1);
        bullets.splice(j,1);
        score++;
        updateHint();
        died = true;
        break;
      }
    }
    if(died) continue;
  }
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    if(player.x < e.x + e.w && player.x + player.w > e.x && player.y < e.y + e.h && player.y + player.h > e.y){
      enemies.splice(i,1);
      score--;
      updateHint();
    }
  }
}

function drawEverything(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = 'cyan';
  ctx.fillRect(player.x, player.y, player.w, player.h);
  ctx.fillStyle = 'yellow';
  for(const b of bullets) ctx.fillRect(b.x, b.y, b.w, b.h);
  ctx.fillStyle = 'red';
  for(const e of enemies) ctx.fillRect(e.x, e.y, e.w, e.h);
  ctx.fillStyle = 'white';
  ctx.font = '20px Arial';
  ctx.fillText('Punkty: ' + score, 10, 25);
}

function gameLoop(){
  if(!playing) return;
  movePlayer();
  moveBullets();
  moveEnemies();
  checkCollisions();
  drawEverything();
  animationFrameId = requestAnimationFrame(gameLoop);
}

/* =======================
   START / STOP / RESTART
======================= */
function startGame(){
  if(playing) return;

  nickname = nicknameInput.value.trim();
  if(!nickname){
    alert('Wpisz swój nick, aby rozpocząć grę!');
    return;
  }

  menuControls.style.display = 'none';
  inGameControls.style.display = 'block';
  adminBtns.style.display = (nickname === 'test6521') ? 'block' : 'none';

  initGameState();
  loadBoard();
  playing = true;

  if(enemyInterval) { clearInterval(enemyInterval); enemyInterval = null; }
  enemyInterval = setInterval(spawnEnemy, 800);
  gameLoop();
}

function endGame(){
  if(!playing) return;
  playing = false;
  if(enemyInterval){ clearInterval(enemyInterval); enemyInterval = null; }
  if(animationFrameId){ cancelAnimationFrame(animationFrameId); animationFrameId = null; }
  if(uziInterval){ clearInterval(uziInterval); uziInterval = null; }

  saveBoard();
  menuControls.style.display = 'block';
  inGameControls.style.display = 'none';
  adminBtns.style.display = 'none';
  nicknameInput.value = ''; // wyczyść pole po zakończeniu gry
  alert('Gra zakończona! Twój wynik: ' + score);
}

function restartGame(){
  if(enemyInterval){ clearInterval(enemyInterval); enemyInterval = null; }
  if(animationFrameId){ cancelAnimationFrame(animationFrameId); animationFrameId = null; }
  if(uziInterval){ clearInterval(uziInterval); uziInterval = null; }

  nickname = nicknameInput.value.trim();
  if(!nickname){
    alert('Wpisz swój nick, aby rozpocząć grę!');
    menuControls.style.display = 'block';
    inGameControls.style.display = 'none';
    return;
  }

  initGameState();
  menuControls.style.display = 'none';
  inGameControls.style.display = 'block';
  adminBtns.style.display = (nickname === 'test6521') ? 'block' : 'none';
  playing = true;
  enemyInterval = setInterval(spawnEnemy, 800);
  gameLoop();
}

document.addEventListener('keydown', (ev)=>{
  const e = ev.key;
  keys[e.toLowerCase()] = true;

  if(e === ' '){
    if(weapon === WEAPONS.UZI){
      if(!uziInterval){ uziInterval = setInterval(shoot, 100); }
    } else { shoot(); }
  }

  if(e.toLowerCase() === 'e'){
    if(weapon === WEAPONS.PISTOL && score >= SHOTGUN_COST){
      score -= SHOTGUN_COST;
      weapon = WEAPONS.SHOTGUN;
      updateHint();
    }
  }
  if(e.toLowerCase() === 'q'){
    if(weapon !== WEAPONS.UZI && score >= UZI_COST){
      score -= UZI_COST;
      weapon = WEAPONS.UZI;
      if(uziInterval){ clearInterval(uziInterval); uziInterval = null; }
      updateHint();
    }
  }

  if(e === 'Escape'){ endGame(); }
});

document.addEventListener('keyup', (ev)=>{
  const e = ev.key;
  keys[e.toLowerCase()] = false;
  if(e === ' ' && uziInterval){ clearInterval(uziInterval); uziInterval = null; }
});

startBtn.addEventListener('click', startGame);
endBtn.addEventListener('click', endGame);
restartBtn.addEventListener('click', restartGame);

add100Btn.addEventListener('click', ()=> {
  if(nickname === 'test6521'){ score += 100; updateHint(); }
});
resetBoardBtn.addEventListener('click', ()=> {
  if(nickname === 'test6521'){ leaderboard = {}; localStorage.removeItem('leaderboard'); renderBoard(); alert('Leaderboard zresetowany'); }
});

loadBoard();
updateHint();
</script>
</body>
</html>
